# Обзор системы двухэтапной классификации ОКПД2

## 🎯 Цель системы

Автоматическая классификация товаров по классификатору ОКПД2 с использованием искусственного интеллекта Claude для обработки больших объемов данных.

## 📊 Архитектура решения

### Двухэтапный подход

#### Этап 1: Первичная классификация (5-значные группы)
- **Цель**: Определить все возможные группы ОКПД2 (формат XX.XX.X) для каждого товара
- **Особенности**: 
  - Множественная классификация (товар может принадлежать нескольким группам)
  - Обработка больших батчей (до 50 товаров за раз)
  - Высокая скорость обработки

#### Этап 2: Детальная классификация
- **Цель**: Найти максимально точный код ОКПД2 внутри определенного класса
- **Особенности**:
  - Обработка по 2-значным классам
  - Использование полного дерева ОКПД2
  - Строгие критерии соответствия
  - Меньшие батчи (10-20 товаров)

### Компоненты системы

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Source MongoDB │────▶│ Migration Worker│────▶│ Target MongoDB  │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                                          │
                                ┌─────────────────────────┤
                                │                         │
                                ▼                         ▼
                    ┌─────────────────────┐   ┌─────────────────────┐
                    │ Classification      │   │ Classification      │
                    │ Worker Stage 1      │   │ Worker Stage 2      │
                    └──────────┬──────────┘   └──────────┬──────────┘
                               │                         │
                               ▼                         ▼
                        ┌─────────────┐           ┌─────────────┐
                        │ Claude API  │           │ Claude API  │
                        └─────────────┘           └─────────────┘
```

## 🗄️ Структура данных

### После первого этапа
```javascript
{
  "collection_name": "products",
  "old_mongo_id": "6823aecaa470...",
  "title": "Журнал регистрации входящих документов",
  "okpd_group": ["17.23.1", "58.14.1"],  // 5-значные группы
  "status_stg1": "classified",
  "created_at": "2024-01-15T10:00:00Z",
  "batch_id": "batch_12345",
  "worker_id": "worker_1"
}
```

### После второго этапа
```javascript
{
  // ... все поля первого этапа ...
  "okpd2_code": "17.23.13.110",
  "okpd2_name": "Журналы регистрационные из бумаги или картона",
  "status_stg2": "classified",
  "stage2_started_at": "2024-01-15T11:00:00Z",
  "stage2_completed_at": "2024-01-15T11:01:00Z",
  "stage2_batch_id": "s2_batch_12345",
  "stage2_worker_id": "stage2_worker_1"
}
```

## 🚀 Процесс работы

### 1. Подготовка
```bash
# Создание файлов данных
data/okpd2_5digit_groups.txt    # Список 5-значных групп для этапа 1
data/okpd2_full_tree.json       # Полное дерево ОКПД2 для этапа 2

# Конвертация из CSV
python scripts/convert_okpd2_to_json.py okpd2.csv --extract-groups
```

### 2. Инициализация
```bash
# Проверка и создание индексов
make init-db
```

### 3. Миграция товаров
```bash
# Запуск миграции из source в target
make migration-start API_KEY=your-key

# Или через Docker
docker-compose -f docker-compose.prod.yml up migration-worker
```

### 4. Первый этап классификации
```bash
# Запуск воркеров
make worker-stage1

# Мониторинг
make monitor API_KEY=your-key
```

### 5. Второй этап классификации
```bash
# Проверка готовности
make stage2-check

# Запуск классификации
make stage2-start API_KEY=your-key

# Запуск воркеров
make worker-stage2
```

### 6. Анализ и экспорт
```bash
# Анализ результатов
make analyze

# Экспорт в Excel
make export-excel
```

## 📈 Производительность

### Первый этап
- **Миграция**: ~1000 товаров/сек
- **Классификация**: ~50 товаров за вызов API
- **С 3 воркерами**: ~900 товаров/мин

### Второй этап
- **Классификация**: ~20 товаров за вызов API
- **С 2 воркерами**: ~300 товаров/мин
- **Обработка по классам**: параллельная обработка разных классов

### Для 100,000 товаров
- **Миграция**: ~2 минуты
- **Первый этап**: ~2 часа (с 3 воркерами)
- **Второй этап**: ~5 часов (с 2 воркерами)

## 🔧 Конфигурация

### Основные параметры (.env)
```bash
# Размеры батчей
MIGRATION_BATCH_SIZE=1000       # Для миграции
CLASSIFICATION_BATCH_SIZE=10    # Для первого этапа (уменьшено для rate limits)

# Rate limiting
RATE_LIMIT_DELAY=10            # Задержка между батчами (сек)
MAX_RETRIES=3                  # Попытки при rate limit

# Модель AI
ANTHROPIC_MODEL=claude-3-haiku-20240307  # Быстрая и дешевая
```

### Оптимизация для rate limits
1. Уменьшите `CLASSIFICATION_BATCH_SIZE` до 10-15
2. Увеличьте `RATE_LIMIT_DELAY` до 15-20 секунд
3. Используйте меньше параллельных воркеров
4. Используйте модель `claude-3-haiku` вместо более мощных

## 📊 API Endpoints

### Мониторинг
- `GET /api/v1/monitoring/stats` - статистика первого этапа
- `GET /api/v1/monitoring/workers/health` - здоровье воркеров

### Первый этап
- `POST /api/v1/classification/migration/start` - начать миграцию
- `GET /api/v1/classification/migration/{job_id}` - статус миграции
- `GET /api/v1/classification/stats/by-group` - статистика по группам

### Второй этап
- `GET /api/v1/classification/stage2/available-classes` - доступные классы
- `POST /api/v1/classification/stage2/start/{class}` - начать классификацию класса
- `GET /api/v1/classification/stage2/stats/stage2` - общая статистика
- `GET /api/v1/classification/stage2/job/{job_id}` - статус задачи

## 🐳 Docker Deployment

### Production окружение
```yaml
services:
  api:                    # REST API сервер
  redis:                  # Координация воркеров
  migration-worker:       # Миграция товаров
  classification-worker-1 # Воркер первого этапа
  classification-worker-2 # Воркер первого этапа
  classification-worker-stage2-1  # Воркер второго этапа
  classification-worker-stage2-2  # Воркер второго этапа
```

### Масштабирование
```bash
# Увеличить количество воркеров первого этапа
docker-compose -f docker-compose.prod.yml up -d --scale classification-worker-1=5

# Увеличить количество воркеров второго этапа
docker-compose -f docker-compose.prod.yml up -d --scale classification-worker-stage2-1=3
```

## 🔍 Полезные команды

### Быстрые команды
```bash
make stats              # Статистика первого этапа
make stage2-stats       # Статистика второго этапа
make monitor            # Полный мониторинг
make analyze            # Анализ результатов
make cleanup-stuck      # Очистка застрявших товаров
```

### Полный цикл
```bash
make full-cycle API_KEY=your-key
```

## 📝 Файлы и директории

```
okpd2-classifier/
├── src/
│   ├── api/               # REST API endpoints
│   ├── core/              # Конфигурация и метрики
│   ├── models/            # Pydantic модели
│   ├── services/          # Бизнес-логика
│   ├── storage/           # Работа с БД
│   └── workers/           # Фоновые воркеры
├── scripts/               # Утилиты и скрипты
├── prompts/               # Шаблоны промптов
├── data/                  # Данные ОКПД2
├── exports/               # Экспортированные результаты
├── logs/                  # Логи
└── docker-compose.yml     # Docker конфигурация
```

## ⚠️ Важные замечания

1. **Rate Limits**: Claude API имеет ограничения на количество запросов. Настройте параметры соответственно.

2. **Качество данных**: Качество классификации зависит от качества исходных названий товаров.

3. **Множественная классификация**: На первом этапе товар может получить несколько групп ОКПД2.

4. **Точность второго этапа**: Не все товары получат точный код - это нормально, если точного соответствия нет.

5. **Proxy/VPN**: Если нужен для доступа к Claude API, настройте через переменные окружения.

## 📚 Дополнительная документация

- API документация: http://localhost:8000/docs